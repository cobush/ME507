<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.20"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Final Project: main_drive.cpp File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Final Project
   </div>
   <div id="projectbrief">This projects goal is to balance a cube on its edge using a reaction wheel. We employed code developed by users on Github to access the IMU and set up the PID controller. All references to source code are in main.cpp. See report for task and state diagrams for fully functioning balancing cube.</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.20 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="summary">
<a href="#func-members">Functions</a> &#124;
<a href="#var-members">Variables</a>  </div>
  <div class="headertitle">
<div class="title">main_drive.cpp File Reference</div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><code>#include &lt;Arduino.h&gt;</code><br />
<code>#include &lt;PrintStream.h&gt;</code><br />
<code>#include &quot;<a class="el" href="taskshare_8h_source.html">taskshare.h</a>&quot;</code><br />
</div>
<p><a href="main__drive_8cpp_source.html">Go to the source code of this file.</a></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:a83e2559905ce06de071389dfb6ea3b97"><td class="memItemLeft" align="right" valign="top">int32_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="main__drive_8cpp.html#a83e2559905ce06de071389dfb6ea3b97">parseIntWithEcho</a> (Stream &amp;stream)</td></tr>
<tr class="memdesc:a83e2559905ce06de071389dfb6ea3b97"><td class="mdescLeft">&#160;</td><td class="mdescRight">Read an integer from a serial device, echoing input and blocking.  <a href="main__drive_8cpp.html#a83e2559905ce06de071389dfb6ea3b97">More...</a><br /></td></tr>
<tr class="separator:a83e2559905ce06de071389dfb6ea3b97"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:aedae232608142fbbd4ece4cfe363e74c"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="main__drive_8cpp.html#aedae232608142fbbd4ece4cfe363e74c">task_sim</a> (void *p_params)</td></tr>
<tr class="memdesc:aedae232608142fbbd4ece4cfe363e74c"><td class="mdescLeft">&#160;</td><td class="mdescRight">Task which interacts with a user.  <a href="main__drive_8cpp.html#aedae232608142fbbd4ece4cfe363e74c">More...</a><br /></td></tr>
<tr class="separator:aedae232608142fbbd4ece4cfe363e74c"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a5d113b2e78f295f62b2c160ebb5d775e"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="main__drive_8cpp.html#a5d113b2e78f295f62b2c160ebb5d775e">task_enc</a> (void *p_params)</td></tr>
<tr class="memdesc:a5d113b2e78f295f62b2c160ebb5d775e"><td class="mdescLeft">&#160;</td><td class="mdescRight">Task which interacts with a user.  <a href="main__drive_8cpp.html#a5d113b2e78f295f62b2c160ebb5d775e">More...</a><br /></td></tr>
<tr class="separator:a5d113b2e78f295f62b2c160ebb5d775e"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a4fc01d736fe50cf5b977f755b675f11d"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="main__drive_8cpp.html#a4fc01d736fe50cf5b977f755b675f11d">setup</a> ()</td></tr>
<tr class="memdesc:a4fc01d736fe50cf5b977f755b675f11d"><td class="mdescLeft">&#160;</td><td class="mdescRight">Arduino setup function which runs once at program startup.  <a href="main__drive_8cpp.html#a4fc01d736fe50cf5b977f755b675f11d">More...</a><br /></td></tr>
<tr class="separator:a4fc01d736fe50cf5b977f755b675f11d"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:afe461d27b9c48d5921c00d521181f12f"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="main__drive_8cpp.html#afe461d27b9c48d5921c00d521181f12f">loop</a> ()</td></tr>
<tr class="memdesc:afe461d27b9c48d5921c00d521181f12f"><td class="mdescLeft">&#160;</td><td class="mdescRight">Arduino's low-priority loop function, which we don't use.  <a href="main__drive_8cpp.html#afe461d27b9c48d5921c00d521181f12f">More...</a><br /></td></tr>
<tr class="separator:afe461d27b9c48d5921c00d521181f12f"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="var-members"></a>
Variables</h2></td></tr>
<tr class="memitem:a0d755a47b31dfe34438194d3286599cc"><td class="memItemLeft" align="right" valign="top"><a class="el" href="class_share.html">Share</a>&lt; uint32_t &gt;&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="main__drive_8cpp.html#a0d755a47b31dfe34438194d3286599cc">duty_cycle</a> (&quot;Power&quot;)</td></tr>
<tr class="separator:a0d755a47b31dfe34438194d3286599cc"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<h2 class="groupheader">Function Documentation</h2>
<a id="afe461d27b9c48d5921c00d521181f12f"></a>
<h2 class="memtitle"><span class="permalink"><a href="#afe461d27b9c48d5921c00d521181f12f">&#9670;&nbsp;</a></span>loop()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void loop </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Arduino's low-priority loop function, which we don't use. </p>
<p>A non-RTOS Arduino program runs all of its continuously running code in this function after <code><a class="el" href="main__drive_8cpp.html#a4fc01d736fe50cf5b977f755b675f11d" title="Arduino setup function which runs once at program startup.">setup()</a></code> has finished. When using FreeRTOS, <code><a class="el" href="main__drive_8cpp.html#afe461d27b9c48d5921c00d521181f12f" title="Arduino&#39;s low-priority loop function, which we don&#39;t use.">loop()</a></code> implements a low priority task on most microcontrollers, and crashes on some others, so we'll not use it. </p>

<p class="definition">Definition at line <a class="el" href="main__drive_8cpp_source.html#l00266">266</a> of file <a class="el" href="main__drive_8cpp_source.html">main_drive.cpp</a>.</p>
<div class="fragment"><div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;{</div>
<div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;}</div>
</div><!-- fragment -->
</div>
</div>
<a id="a83e2559905ce06de071389dfb6ea3b97"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a83e2559905ce06de071389dfb6ea3b97">&#9670;&nbsp;</a></span>parseIntWithEcho()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int32_t parseIntWithEcho </td>
          <td>(</td>
          <td class="paramtype">Stream &amp;&#160;</td>
          <td class="paramname"><em>stream</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Read an integer from a serial device, echoing input and blocking. </p>
<p>This function reads an integer which is typed by a user into a serial device. It uses the Arduino function <code>readBytes()</code>, which blocks the task which calls this function until a character is read. When any character is received, it is echoed through the serial port so the user can see what was typed. Only decimal integers are supported; negative integers beginning with a single <code>-</code> sign or positive ones with a <code>+</code> will work.</p>
<p><b>NOTE:</b> The serial device must have its timeout set to a very long time, or this function will malfunction. A recommended call: </p><div class="fragment"><div class="line">Serial.setTimeout (0xFFFFFFFF);</div>
</div><!-- fragment --><p> Assuming that the serial port named <code>Serial</code> is being used. </p><dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">stream</td><td>The serial device such as <code>Serial</code> used to communicate </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="main__drive_8cpp_source.html#l00045">45</a> of file <a class="el" href="main__drive_8cpp_source.html">main_drive.cpp</a>.</p>
<div class="fragment"><div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;{</div>
<div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;    <span class="keyword">const</span> uint8_t MAX_INT_DIGITS = 24;        <span class="comment">// More than a 64-bit integer has</span></div>
<div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;    <span class="keywordtype">char</span> ch_in = 0;                           <span class="comment">// One character from the buffer</span></div>
<div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;    <span class="keywordtype">char</span> in_buf[MAX_INT_DIGITS];              <span class="comment">// Character buffer for input</span></div>
<div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;    uint8_t count = 0;                        <span class="comment">// Counts characters received</span></div>
<div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160; </div>
<div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;    <span class="comment">// Read until return is received or too many characters have been read.</span></div>
<div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;    <span class="comment">// The readBytes function blocks while waiting for characters</span></div>
<div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;    <span class="keywordflow">while</span> (<span class="keyword">true</span>)</div>
<div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;    {</div>
<div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;        stream.readBytes (&amp;ch_in, 1);         <span class="comment">// Read (and wait for) characters</span></div>
<div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;        in_buf[count++] = ch_in;</div>
<div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;        stream.print (ch_in);                 <span class="comment">// Echo the character</span></div>
<div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;        <span class="keywordflow">if</span> (ch_in == <span class="charliteral">&#39;\b&#39;</span> &amp;&amp; count)           <span class="comment">// If a backspace, back up one</span></div>
<div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;        {                                     <span class="comment">// character and try again</span></div>
<div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;            count -= 2;</div>
<div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;        }</div>
<div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;        <span class="keywordflow">if</span> (ch_in == <span class="charliteral">&#39;\n&#39;</span> || count &gt;= (MAX_INT_DIGITS - 1))</div>
<div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;        {</div>
<div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;            in_buf[count] = <span class="charliteral">&#39;\0&#39;</span>;             <span class="comment">// String must have a \0 at end</span></div>
<div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;            <span class="keywordflow">return</span> atoi (in_buf);</div>
<div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;        }</div>
<div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;    }</div>
<div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;}</div>
</div><!-- fragment -->
</div>
</div>
<a id="a4fc01d736fe50cf5b977f755b675f11d"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a4fc01d736fe50cf5b977f755b675f11d">&#9670;&nbsp;</a></span>setup()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void setup </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Arduino setup function which runs once at program startup. </p>
<p>This function sets up a serial port for communication and creates the tasks which will be run. It also initializes pin A3 on the STM32L476RG microcontroller as an output pin. </p>

<p class="definition">Definition at line <a class="el" href="main__drive_8cpp_source.html#l00216">216</a> of file <a class="el" href="main__drive_8cpp_source.html">main_drive.cpp</a>.</p>
<div class="fragment"><div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;{</div>
<div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;    <span class="comment">// Start the serial port, wait a short time, then say hello. Use the</span></div>
<div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;    <span class="comment">// non-RTOS delay() function because the RTOS hasn&#39;t been started yet</span></div>
<div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;    Serial.begin (115200);</div>
<div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;    delay (2000);</div>
<div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;    Serial &lt;&lt; endl &lt;&lt; endl &lt;&lt; <span class="stringliteral">&quot;ME507 UI Lab Starting Program&quot;</span> &lt;&lt; endl;</div>
<div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160; </div>
<div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;    <span class="comment">// Initialize pin A3 as an output pin</span></div>
<div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;    pinMode(A3, OUTPUT);</div>
<div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;    pinMode(D2, INPUT_PULLDOWN);</div>
<div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;    pinMode(D4, INPUT_PULLDOWN);</div>
<div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160; </div>
<div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160; </div>
<div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;    <span class="comment">// Create a task which prints a slightly disagreeable message</span></div>
<div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;    <span class="comment">/*xTaskCreate (task_ui,</span></div>
<div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;<span class="comment">                 &quot;User Int.&quot;,                     // Name for printouts</span></div>
<div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;<span class="comment">                 1536,                            // Stack size</span></div>
<div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;<span class="comment">                 NULL,                            // Parameters for task fn.</span></div>
<div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;<span class="comment">                 1,                               // Priority</span></div>
<div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;<span class="comment">                 NULL);                           // Task handle*/</span></div>
<div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160; </div>
<div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;    <span class="comment">// Create a task which prints a more agreeable message</span></div>
<div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;    xTaskCreate (<a class="code" href="main__drive_8cpp.html#aedae232608142fbbd4ece4cfe363e74c">task_sim</a>,</div>
<div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;                 <span class="stringliteral">&quot;Simul.&quot;</span>,</div>
<div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;                 1024,                            <span class="comment">// Stack size</span></div>
<div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;                 NULL,</div>
<div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;                 4,                               <span class="comment">// Priority</span></div>
<div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;                 NULL);</div>
<div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;    <span class="comment">// Create a task which prints the current encoder position</span></div>
<div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;    xTaskCreate (<a class="code" href="main__drive_8cpp.html#a5d113b2e78f295f62b2c160ebb5d775e">task_enc</a>,</div>
<div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;                 <span class="stringliteral">&quot;Simul.&quot;</span>,</div>
<div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;                 1024,                            <span class="comment">// Stack size</span></div>
<div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;                 NULL,</div>
<div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;                 4,                               <span class="comment">// Priority</span></div>
<div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;                 NULL);</div>
<div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;    <span class="comment">// If using an STM32, we need to call the scheduler startup function now;</span></div>
<div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;    <span class="comment">// if using an ESP32, it has already been called for us</span></div>
<div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;<span class="preprocessor">    #if (defined STM32L4xx || defined STM32F4xx)</span></div>
<div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;        vTaskStartScheduler ();</div>
<div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;<span class="preprocessor">    #endif</span></div>
<div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;}</div>
</div><!-- fragment -->
</div>
</div>
<a id="a5d113b2e78f295f62b2c160ebb5d775e"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a5d113b2e78f295f62b2c160ebb5d775e">&#9670;&nbsp;</a></span>task_enc()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void task_enc </td>
          <td>(</td>
          <td class="paramtype">void *&#160;</td>
          <td class="paramname"><em>p_params</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Task which interacts with a user. </p>
<p>This task demonstrates how to use a FreeRTOS task for interacting with some user while other more important things are going on. In other words, this task prompts the user to input a value for the duty cycle of a "motor". This value is then put into the share duty_cycle to be used in the task task_sim </p><dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">p_params</td><td>A pointer to function parameters which we don't use. </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="main__drive_8cpp_source.html#l00161">161</a> of file <a class="el" href="main__drive_8cpp_source.html">main_drive.cpp</a>.</p>
<div class="fragment"><div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;{</div>
<div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;    (void)p_params;            <span class="comment">// Does nothing but shut up a compiler warning</span></div>
<div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160; </div>
<div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;    <span class="comment">// Set the timeout for reading from the serial port to the maximum</span></div>
<div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;    <span class="comment">// possible value, essentially forever for a real-time control program</span></div>
<div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;    Serial.setTimeout (0xFFFFFFFF);</div>
<div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160; </div>
<div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;    <span class="comment">// EncoderValues are bools</span></div>
<div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;    <span class="keywordtype">bool</span> EncoderValueA;</div>
<div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;    <span class="keywordtype">bool</span> EncoderValueB;</div>
<div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;    uint32_t EncoderPosition;</div>
<div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;    uint32_t LastEncoderPosition;</div>
<div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;    uint32_t EncoderSpeed;</div>
<div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;    uint32_t LastTime;</div>
<div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;    <span class="comment">// Resets the EncoderPosition to zero</span></div>
<div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;    EncoderPosition = 0;</div>
<div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;    LastEncoderPosition = 0;</div>
<div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;    <span class="comment">// The task&#39;s infinite loop goes here</span></div>
<div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;    <span class="keywordflow">for</span> (;;)</div>
<div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;    {</div>
<div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;    <span class="comment">// Converts the encoder readings into encoder position</span></div>
<div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;    <span class="keywordflow">if</span> (digitalRead(D2)) {</div>
<div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;        <span class="keywordflow">if</span> (digitalRead(D4) &amp;&amp; not EncoderValueB) { </div>
<div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;            EncoderPosition += 1;</div>
<div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;        }</div>
<div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (not digitalRead(D4) &amp;&amp; EncoderValueB) {</div>
<div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;            EncoderPosition -= 1;</div>
<div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;        }</div>
<div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;    }</div>
<div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (digitalRead(D2)) {</div>
<div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;        <span class="keywordflow">if</span> (not digitalRead(D4) &amp;&amp; EncoderValueB) { </div>
<div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;            EncoderPosition += 1;</div>
<div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;        }</div>
<div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (digitalRead(D4) &amp;&amp; not EncoderValueB) {</div>
<div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;            EncoderPosition -= 1;</div>
<div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;        }</div>
<div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;    }</div>
<div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;    <span class="comment">// Calculate the encoder speed</span></div>
<div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;    EncoderSpeed = (EncoderPosition - LastEncoderPosition)/(micros() - LastTime);</div>
<div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;    <span class="comment">// Captures the new encoder readings</span></div>
<div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;    EncoderValueA = digitalRead(D2);</div>
<div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;    EncoderValueB = digitalRead(D4);  </div>
<div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;    <span class="comment">// Sets the LastEncoderPosition</span></div>
<div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;    LastEncoderPosition = EncoderPosition;</div>
<div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;    <span class="comment">// Prints the current encoder readings and position</span></div>
<div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;    Serial &lt;&lt; EncoderValueA &lt;&lt; <span class="stringliteral">&quot;|&quot;</span> &lt;&lt;EncoderValueB &lt;&lt; <span class="stringliteral">&quot;|&quot;</span> &lt;&lt;EncoderPosition &lt;&lt; <span class="stringliteral">&quot;|&quot;</span> &lt;&lt; endl;  </div>
<div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;    }</div>
<div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;}</div>
</div><!-- fragment -->
</div>
</div>
<a id="aedae232608142fbbd4ece4cfe363e74c"></a>
<h2 class="memtitle"><span class="permalink"><a href="#aedae232608142fbbd4ece4cfe363e74c">&#9670;&nbsp;</a></span>task_sim()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void task_sim </td>
          <td>(</td>
          <td class="paramtype">void *&#160;</td>
          <td class="paramname"><em>p_params</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Task which interacts with a user. </p>
<p>This task demonstrates how to use a FreeRTOS task for interacting with some user while other more important things are going on. In other words, this task prompts the user to input a value for the duty cycle of a "motor". This value is then put into the share duty_cycle to be used in the task task_sim </p><dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">p_params</td><td>A pointer to function parameters which we don't use.</td></tr>
  </table>
  </dd>
</dl>
<p>Task which simulates a motor.  This task runs at precise intervals using <code>vTaskDelayUntil()</code> and sort of simulates a motor whose duty cycle is controlled by a power level sent from the UI task. The simulation is just a very simple implementation of a first-order filter. </p><dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">p_params</td><td>A pointer to function parameters which we don't use. </td></tr>
  </table>
  </dd>
</dl>

<p class="definition">Definition at line <a class="el" href="main__drive_8cpp_source.html#l00114">114</a> of file <a class="el" href="main__drive_8cpp_source.html">main_drive.cpp</a>.</p>
<div class="fragment"><div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;{</div>
<div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;    (void)p_params;                           <span class="comment">// Shuts up a compiler warning</span></div>
<div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160; </div>
<div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;    <span class="comment">// Set up the variables of the simulation here</span></div>
<div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;    <span class="keyword">const</span> TickType_t sim_period = 50;         <span class="comment">// RTOS ticks (ms) between runs</span></div>
<div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160; </div>
<div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;    <span class="comment">// Initialise the xLastWakeTime variable with the current time.</span></div>
<div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;    <span class="comment">// It is used to run the task at precise intervals in the for loop below.</span></div>
<div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;    TickType_t xLastWakeTime = xTaskGetTickCount();</div>
<div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;    </div>
<div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;    <span class="comment">// shared_power is a 32 bit unsigned integer. Initialize the variable shared_power</span></div>
<div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;    <span class="comment">// to 0.</span></div>
<div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;    uint32_t shared_power = 0;</div>
<div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160; </div>
<div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;    <span class="keywordflow">for</span> (;;)</div>
<div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;    {</div>
<div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;      <span class="comment">// Collect the value placed in share duty_cycle</span></div>
<div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;      <a class="code" href="main__drive_8cpp.html#a0d755a47b31dfe34438194d3286599cc">duty_cycle</a>.get (shared_power);</div>
<div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;      </div>
<div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;      <span class="comment">// sim_A is a floating point number</span></div>
<div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;      <span class="keywordtype">float</span> sim_A = .99; </div>
<div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160; </div>
<div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;      <span class="comment">// sim_B is also a floating point number</span></div>
<div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;      <span class="keywordtype">float</span> sim_B = 1 - sim_A; </div>
<div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160; </div>
<div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;      <span class="comment">// sim_speed updates as the speed of the &quot;motor&quot; increases</span></div>
<div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;      <span class="keywordtype">float</span> sim_speed = sim_speed * sim_A + shared_power * sim_B;</div>
<div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160; </div>
<div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;      <span class="comment">// write the appropriate PWM signal to pin A3 depending on input</span></div>
<div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;      analogWrite(A3, sim_speed); </div>
<div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160; </div>
<div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;        <span class="comment">// This type of delay waits until it has been the given number of RTOS</span></div>
<div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;        <span class="comment">// ticks since the task previously began running. This prevents timing</span></div>
<div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;        <span class="comment">// inaccuracy due to not accounting for how long the task took to run</span></div>
<div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;      vTaskDelayUntil (&amp;xLastWakeTime, sim_period);</div>
<div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;    }</div>
<div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;}</div>
</div><!-- fragment -->
</div>
</div>
<h2 class="groupheader">Variable Documentation</h2>
<a id="a0d755a47b31dfe34438194d3286599cc"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a0d755a47b31dfe34438194d3286599cc">&#9670;&nbsp;</a></span>duty_cycle</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="class_share.html">Share</a>&lt;uint32_t&gt; duty_cycle(&quot;Power&quot;)</td>
        </tr>
      </table>
</div><div class="memdoc">

</div>
</div>
</div><!-- contents -->
<div class="ttc" id="amain__drive_8cpp_html_a0d755a47b31dfe34438194d3286599cc"><div class="ttname"><a href="main__drive_8cpp.html#a0d755a47b31dfe34438194d3286599cc">duty_cycle</a></div><div class="ttdeci">Share&lt; uint32_t &gt; duty_cycle(&quot;Power&quot;)</div></div>
<div class="ttc" id="amain__drive_8cpp_html_a5d113b2e78f295f62b2c160ebb5d775e"><div class="ttname"><a href="main__drive_8cpp.html#a5d113b2e78f295f62b2c160ebb5d775e">task_enc</a></div><div class="ttdeci">void task_enc(void *p_params)</div><div class="ttdoc">Task which interacts with a user.</div><div class="ttdef"><b>Definition:</b> <a href="main__drive_8cpp_source.html#l00161">main_drive.cpp:161</a></div></div>
<div class="ttc" id="amain__drive_8cpp_html_aedae232608142fbbd4ece4cfe363e74c"><div class="ttname"><a href="main__drive_8cpp.html#aedae232608142fbbd4ece4cfe363e74c">task_sim</a></div><div class="ttdeci">void task_sim(void *p_params)</div><div class="ttdoc">Task which interacts with a user.</div><div class="ttdef"><b>Definition:</b> <a href="main__drive_8cpp_source.html#l00114">main_drive.cpp:114</a></div></div>
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="http://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.8.20
</small></address>
</body>
</html>
