<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.20"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Final Project: main_drive.cpp Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Final Project
   </div>
   <div id="projectbrief">This projects goal is to balance a cube on its edge using a reaction wheel. We employed code developed by users on Github to access the IMU and set up the PID controller. All references to source code are in main.cpp. See report for task and state diagrams for fully functioning balancing cube.</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.20 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">main_drive.cpp</div>  </div>
</div><!--header-->
<div class="contents">
<a href="main__drive_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="comment">/** @file main.cpp</span></div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="comment"> *    This file contains a partially written program which students should</span></div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="comment"> *    greatly improve so that it runs a very crude simulation of a motor. </span></div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="comment"> *</span></div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="comment"> *  @author  Blake Carbonneau (Team CDC)</span></div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;<span class="comment"> *  @author  Joseph Heald</span></div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;<span class="comment"> *  @author  Connor Bush</span></div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;<span class="comment"> *  @author  Giovanni Guerrero</span></div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;<span class="comment"> * </span></div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;<span class="comment"> *  @date    28 Sep 2020 Original file</span></div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;<span class="comment"> *  @date    9 Oct 2020  Added another task because I got bored</span></div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;<span class="comment"> *  @date    12 Oct 2020 Took out unneeded junk to make a lab starting program</span></div>
<div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;<span class="comment"> *  @date    14 Oct 2020 Copied file from Canvas </span></div>
<div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;<span class="comment"> *  @date    15 Oct 2020 Included code for task_ui and task_sim</span></div>
<div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;<span class="comment"> *  @date    16 Oct 2020 Included code to assign A3 as an output pin</span></div>
<div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;<span class="comment"> */</span></div>
<div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160; </div>
<div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;<span class="preprocessor">#include &lt;Arduino.h&gt;</span></div>
<div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;<span class="preprocessor">#include &lt;PrintStream.h&gt;</span></div>
<div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;<span class="preprocessor">#if (defined STM32L4xx || defined STM32F4xx)</span></div>
<div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;<span class="preprocessor">    #include &lt;STM32FreeRTOS.h&gt;</span></div>
<div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="taskshare_8h.html">taskshare.h</a>&quot;</span></div>
<div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160; </div>
<div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;<span class="comment">// Shares and queues go here</span></div>
<div class="line"><a name="l00026"></a><span class="lineno"><a class="line" href="main__drive_8cpp.html#a0d755a47b31dfe34438194d3286599cc">   26</a></span>&#160;<a class="code" href="class_share.html">Share&lt;uint32_t&gt;</a> <a class="code" href="main__drive_8cpp.html#a0d755a47b31dfe34438194d3286599cc">duty_cycle</a> (<span class="stringliteral">&quot;Power&quot;</span>);</div>
<div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;<span class="comment">/** @brief   Read an integer from a serial device, echoing input and blocking.</span></div>
<div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;<span class="comment"> *  @details This function reads an integer which is typed by a user into a</span></div>
<div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;<span class="comment"> *           serial device. It uses the Arduino function @c readBytes(), which</span></div>
<div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;<span class="comment"> *           blocks the task which calls this function until a character is</span></div>
<div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;<span class="comment"> *           read. When any character is received, it is echoed through the</span></div>
<div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;<span class="comment"> *           serial port so the user can see what was typed. Only decimal</span></div>
<div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;<span class="comment"> *           integers are supported; negative integers beginning with a single</span></div>
<div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;<span class="comment"> *           @c - sign or positive ones with a @c + will work. </span></div>
<div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;<span class="comment"> * </span></div>
<div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;<span class="comment"> *           @b NOTE: The serial device must have its timeout set to a very</span></div>
<div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;<span class="comment"> *           long time, or this function will malfunction. A recommended call:</span></div>
<div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;<span class="comment"> *           @code</span></div>
<div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;<span class="comment"> *           Serial.setTimeout (0xFFFFFFFF);</span></div>
<div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;<span class="comment"> *           @endcode</span></div>
<div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;<span class="comment"> *           Assuming that the serial port named @c Serial is being used.</span></div>
<div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;<span class="comment"> *  @param   stream The serial device such as @c Serial used to communicate</span></div>
<div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;<span class="comment"> */</span></div>
<div class="line"><a name="l00045"></a><span class="lineno"><a class="line" href="main__drive_8cpp.html#a83e2559905ce06de071389dfb6ea3b97">   45</a></span>&#160;int32_t <a class="code" href="main__drive_8cpp.html#a83e2559905ce06de071389dfb6ea3b97">parseIntWithEcho</a> (Stream&amp; stream)</div>
<div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;{</div>
<div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;    <span class="keyword">const</span> uint8_t MAX_INT_DIGITS = 24;        <span class="comment">// More than a 64-bit integer has</span></div>
<div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;    <span class="keywordtype">char</span> ch_in = 0;                           <span class="comment">// One character from the buffer</span></div>
<div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;    <span class="keywordtype">char</span> in_buf[MAX_INT_DIGITS];              <span class="comment">// Character buffer for input</span></div>
<div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;    uint8_t count = 0;                        <span class="comment">// Counts characters received</span></div>
<div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160; </div>
<div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;    <span class="comment">// Read until return is received or too many characters have been read.</span></div>
<div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;    <span class="comment">// The readBytes function blocks while waiting for characters</span></div>
<div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;    <span class="keywordflow">while</span> (<span class="keyword">true</span>)</div>
<div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;    {</div>
<div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;        stream.readBytes (&amp;ch_in, 1);         <span class="comment">// Read (and wait for) characters</span></div>
<div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;        in_buf[count++] = ch_in;</div>
<div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;        stream.print (ch_in);                 <span class="comment">// Echo the character</span></div>
<div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;        <span class="keywordflow">if</span> (ch_in == <span class="charliteral">&#39;\b&#39;</span> &amp;&amp; count)           <span class="comment">// If a backspace, back up one</span></div>
<div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;        {                                     <span class="comment">// character and try again</span></div>
<div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;            count -= 2;</div>
<div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;        }</div>
<div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;        <span class="keywordflow">if</span> (ch_in == <span class="charliteral">&#39;\n&#39;</span> || count &gt;= (MAX_INT_DIGITS - 1))</div>
<div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;        {</div>
<div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;            in_buf[count] = <span class="charliteral">&#39;\0&#39;</span>;             <span class="comment">// String must have a \0 at end</span></div>
<div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;            <span class="keywordflow">return</span> atoi (in_buf);</div>
<div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;        }</div>
<div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;    }</div>
<div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;}</div>
<div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160; </div>
<div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;<span class="comment">/** @brief   Task which interacts with a user. </span></div>
<div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;<span class="comment"> *  @details This task demonstrates how to use a FreeRTOS task for interacting</span></div>
<div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;<span class="comment"> *           with some user while other more important things are going on. In</span></div>
<div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;<span class="comment"> *           other words, this task prompts the user to input a value for the </span></div>
<div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;<span class="comment"> *           duty cycle of a &quot;motor&quot;. This value is then put into the share</span></div>
<div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;<span class="comment"> *           duty_cycle to be used in the task task_sim</span></div>
<div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;<span class="comment"> *  @param   p_params A pointer to function parameters which we don&#39;t use.</span></div>
<div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;<span class="comment"> */</span></div>
<div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;<span class="comment">/*void task_ui (void* p_params)</span></div>
<div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;<span class="comment">{</span></div>
<div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;<span class="comment">    (void)p_params;            // Does nothing but shut up a compiler warning</span></div>
<div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;<span class="comment">    // Set the timeout for reading from the serial port to the maximum</span></div>
<div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;<span class="comment">    // possible value, essentially forever for a real-time control program</span></div>
<div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;<span class="comment">    Serial.setTimeout (0xFFFFFFFF);</span></div>
<div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;<span class="comment">    // The task&#39;s infinite loop goes here</span></div>
<div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;<span class="comment">    for (;;)</span></div>
<div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;<span class="comment">    {</span></div>
<div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;<span class="comment">      // Prompt the user  </span></div>
<div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;<span class="comment">      Serial &lt;&lt; &quot;Enter a Duty Cycle: &quot;; </span></div>
<div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;<span class="comment">      // num is a 32 bit integer</span></div>
<div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;<span class="comment">      uint32_t num; </span></div>
<div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;<span class="comment">      // set num to the value input by the user</span></div>
<div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;<span class="comment">      num = parseIntWithEcho(Serial); </span></div>
<div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;<span class="comment">      // place num in the share duty_cycle</span></div>
<div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;<span class="comment">      duty_cycle.put(num); </span></div>
<div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;<span class="comment">    }</span></div>
<div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;<span class="comment">    </span></div>
<div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;<span class="comment">}*/</span></div>
<div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160; </div>
<div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;<span class="comment">/** @brief   Task which simulates a motor.</span></div>
<div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;<span class="comment"> *  @details This task runs at precise intervals using @c vTaskDelayUntil() and</span></div>
<div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;<span class="comment"> *           sort of simulates a motor whose duty cycle is controlled by a</span></div>
<div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;<span class="comment"> *           power level sent from the UI task. The simulation is just a very</span></div>
<div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;<span class="comment"> *           simple implementation of a first-order filter. </span></div>
<div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;<span class="comment"> *  @param   p_params A pointer to function parameters which we don&#39;t use.</span></div>
<div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;<span class="comment"> */</span></div>
<div class="line"><a name="l00114"></a><span class="lineno"><a class="line" href="main__drive_8cpp.html#aedae232608142fbbd4ece4cfe363e74c">  114</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="main__drive_8cpp.html#aedae232608142fbbd4ece4cfe363e74c">task_sim</a> (<span class="keywordtype">void</span>* p_params)</div>
<div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;{</div>
<div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;    (void)p_params;                           <span class="comment">// Shuts up a compiler warning</span></div>
<div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160; </div>
<div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;    <span class="comment">// Set up the variables of the simulation here</span></div>
<div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;    <span class="keyword">const</span> TickType_t sim_period = 50;         <span class="comment">// RTOS ticks (ms) between runs</span></div>
<div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160; </div>
<div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;    <span class="comment">// Initialise the xLastWakeTime variable with the current time.</span></div>
<div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;    <span class="comment">// It is used to run the task at precise intervals in the for loop below.</span></div>
<div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;    TickType_t xLastWakeTime = xTaskGetTickCount();</div>
<div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;    </div>
<div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;    <span class="comment">// shared_power is a 32 bit unsigned integer. Initialize the variable shared_power</span></div>
<div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;    <span class="comment">// to 0.</span></div>
<div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;    uint32_t shared_power = 0;</div>
<div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160; </div>
<div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;    <span class="keywordflow">for</span> (;;)</div>
<div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;    {</div>
<div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;      <span class="comment">// Collect the value placed in share duty_cycle</span></div>
<div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;      <a class="code" href="main__drive_8cpp.html#a0d755a47b31dfe34438194d3286599cc">duty_cycle</a>.get (shared_power);</div>
<div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;      </div>
<div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;      <span class="comment">// sim_A is a floating point number</span></div>
<div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;      <span class="keywordtype">float</span> sim_A = .99; </div>
<div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160; </div>
<div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;      <span class="comment">// sim_B is also a floating point number</span></div>
<div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;      <span class="keywordtype">float</span> sim_B = 1 - sim_A; </div>
<div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160; </div>
<div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;      <span class="comment">// sim_speed updates as the speed of the &quot;motor&quot; increases</span></div>
<div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;      <span class="keywordtype">float</span> sim_speed = sim_speed * sim_A + shared_power * sim_B;</div>
<div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160; </div>
<div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;      <span class="comment">// write the appropriate PWM signal to pin A3 depending on input</span></div>
<div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;      analogWrite(A3, sim_speed); </div>
<div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160; </div>
<div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;        <span class="comment">// This type of delay waits until it has been the given number of RTOS</span></div>
<div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;        <span class="comment">// ticks since the task previously began running. This prevents timing</span></div>
<div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;        <span class="comment">// inaccuracy due to not accounting for how long the task took to run</span></div>
<div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;      vTaskDelayUntil (&amp;xLastWakeTime, sim_period);</div>
<div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;    }</div>
<div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;}</div>
<div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;<span class="comment">/** @brief   Task which interacts with a user. </span></div>
<div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;<span class="comment"> *  @details This task demonstrates how to use a FreeRTOS task for interacting</span></div>
<div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;<span class="comment"> *           with some user while other more important things are going on. In</span></div>
<div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;<span class="comment"> *           other words, this task prompts the user to input a value for the </span></div>
<div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;<span class="comment"> *           duty cycle of a &quot;motor&quot;. This value is then put into the share</span></div>
<div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;<span class="comment"> *           duty_cycle to be used in the task task_sim</span></div>
<div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;<span class="comment"> *  @param   p_params A pointer to function parameters which we don&#39;t use.</span></div>
<div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;<span class="comment"> */</span></div>
<div class="line"><a name="l00161"></a><span class="lineno"><a class="line" href="main__drive_8cpp.html#a5d113b2e78f295f62b2c160ebb5d775e">  161</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="main__drive_8cpp.html#a5d113b2e78f295f62b2c160ebb5d775e">task_enc</a> (<span class="keywordtype">void</span>* p_params)</div>
<div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;{</div>
<div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;    (void)p_params;            <span class="comment">// Does nothing but shut up a compiler warning</span></div>
<div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160; </div>
<div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;    <span class="comment">// Set the timeout for reading from the serial port to the maximum</span></div>
<div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;    <span class="comment">// possible value, essentially forever for a real-time control program</span></div>
<div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;    Serial.setTimeout (0xFFFFFFFF);</div>
<div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160; </div>
<div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;    <span class="comment">// EncoderValues are bools</span></div>
<div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;    <span class="keywordtype">bool</span> EncoderValueA;</div>
<div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;    <span class="keywordtype">bool</span> EncoderValueB;</div>
<div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;    uint32_t EncoderPosition;</div>
<div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;    uint32_t LastEncoderPosition;</div>
<div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;    uint32_t EncoderSpeed;</div>
<div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;    uint32_t LastTime;</div>
<div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;    <span class="comment">// Resets the EncoderPosition to zero</span></div>
<div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;    EncoderPosition = 0;</div>
<div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;    LastEncoderPosition = 0;</div>
<div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;    <span class="comment">// The task&#39;s infinite loop goes here</span></div>
<div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;    <span class="keywordflow">for</span> (;;)</div>
<div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;    {</div>
<div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;    <span class="comment">// Converts the encoder readings into encoder position</span></div>
<div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;    <span class="keywordflow">if</span> (digitalRead(D2)) {</div>
<div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;        <span class="keywordflow">if</span> (digitalRead(D4) &amp;&amp; not EncoderValueB) { </div>
<div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;            EncoderPosition += 1;</div>
<div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;        }</div>
<div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (not digitalRead(D4) &amp;&amp; EncoderValueB) {</div>
<div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;            EncoderPosition -= 1;</div>
<div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;        }</div>
<div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;    }</div>
<div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (digitalRead(D2)) {</div>
<div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;        <span class="keywordflow">if</span> (not digitalRead(D4) &amp;&amp; EncoderValueB) { </div>
<div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;            EncoderPosition += 1;</div>
<div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;        }</div>
<div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (digitalRead(D4) &amp;&amp; not EncoderValueB) {</div>
<div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;            EncoderPosition -= 1;</div>
<div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;        }</div>
<div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;    }</div>
<div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;    <span class="comment">// Calculate the encoder speed</span></div>
<div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;    EncoderSpeed = (EncoderPosition - LastEncoderPosition)/(micros() - LastTime);</div>
<div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;    <span class="comment">// Captures the new encoder readings</span></div>
<div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;    EncoderValueA = digitalRead(D2);</div>
<div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;    EncoderValueB = digitalRead(D4);  </div>
<div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;    <span class="comment">// Sets the LastEncoderPosition</span></div>
<div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;    LastEncoderPosition = EncoderPosition;</div>
<div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;    <span class="comment">// Prints the current encoder readings and position</span></div>
<div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;    Serial &lt;&lt; EncoderValueA &lt;&lt; <span class="stringliteral">&quot;|&quot;</span> &lt;&lt;EncoderValueB &lt;&lt; <span class="stringliteral">&quot;|&quot;</span> &lt;&lt;EncoderPosition &lt;&lt; <span class="stringliteral">&quot;|&quot;</span> &lt;&lt; endl;  </div>
<div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;    }</div>
<div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;}</div>
<div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;<span class="comment">/** @brief   Arduino setup function which runs once at program startup.</span></div>
<div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;<span class="comment"> *  @details This function sets up a serial port for communication and creates</span></div>
<div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;<span class="comment"> *           the tasks which will be run. It also initializes pin A3 on the</span></div>
<div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;<span class="comment"> *           STM32L476RG microcontroller as an output pin.</span></div>
<div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;<span class="comment"> */</span></div>
<div class="line"><a name="l00216"></a><span class="lineno"><a class="line" href="main__drive_8cpp.html#a4fc01d736fe50cf5b977f755b675f11d">  216</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="main__drive_8cpp.html#a4fc01d736fe50cf5b977f755b675f11d">setup</a> () </div>
<div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;{</div>
<div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;    <span class="comment">// Start the serial port, wait a short time, then say hello. Use the</span></div>
<div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;    <span class="comment">// non-RTOS delay() function because the RTOS hasn&#39;t been started yet</span></div>
<div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;    Serial.begin (115200);</div>
<div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;    delay (2000);</div>
<div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;    Serial &lt;&lt; endl &lt;&lt; endl &lt;&lt; <span class="stringliteral">&quot;ME507 UI Lab Starting Program&quot;</span> &lt;&lt; endl;</div>
<div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160; </div>
<div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;    <span class="comment">// Initialize pin A3 as an output pin</span></div>
<div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;    pinMode(A3, OUTPUT);</div>
<div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;    pinMode(D2, INPUT_PULLDOWN);</div>
<div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;    pinMode(D4, INPUT_PULLDOWN);</div>
<div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160; </div>
<div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160; </div>
<div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;    <span class="comment">// Create a task which prints a slightly disagreeable message</span></div>
<div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;    <span class="comment">/*xTaskCreate (task_ui,</span></div>
<div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;<span class="comment">                 &quot;User Int.&quot;,                     // Name for printouts</span></div>
<div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;<span class="comment">                 1536,                            // Stack size</span></div>
<div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;<span class="comment">                 NULL,                            // Parameters for task fn.</span></div>
<div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;<span class="comment">                 1,                               // Priority</span></div>
<div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;<span class="comment">                 NULL);                           // Task handle*/</span></div>
<div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160; </div>
<div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;    <span class="comment">// Create a task which prints a more agreeable message</span></div>
<div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;    xTaskCreate (<a class="code" href="main__drive_8cpp.html#aedae232608142fbbd4ece4cfe363e74c">task_sim</a>,</div>
<div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;                 <span class="stringliteral">&quot;Simul.&quot;</span>,</div>
<div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;                 1024,                            <span class="comment">// Stack size</span></div>
<div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;                 NULL,</div>
<div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;                 4,                               <span class="comment">// Priority</span></div>
<div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;                 NULL);</div>
<div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;    <span class="comment">// Create a task which prints the current encoder position</span></div>
<div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;    xTaskCreate (<a class="code" href="main__drive_8cpp.html#a5d113b2e78f295f62b2c160ebb5d775e">task_enc</a>,</div>
<div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;                 <span class="stringliteral">&quot;Simul.&quot;</span>,</div>
<div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;                 1024,                            <span class="comment">// Stack size</span></div>
<div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;                 NULL,</div>
<div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;                 4,                               <span class="comment">// Priority</span></div>
<div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;                 NULL);</div>
<div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;    <span class="comment">// If using an STM32, we need to call the scheduler startup function now;</span></div>
<div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;    <span class="comment">// if using an ESP32, it has already been called for us</span></div>
<div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;<span class="preprocessor">    #if (defined STM32L4xx || defined STM32F4xx)</span></div>
<div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;        vTaskStartScheduler ();</div>
<div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;<span class="preprocessor">    #endif</span></div>
<div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;}</div>
<div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160; </div>
<div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;<span class="comment">/** @brief   Arduino&#39;s low-priority loop function, which we don&#39;t use.</span></div>
<div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;<span class="comment"> *  @details A non-RTOS Arduino program runs all of its continuously running</span></div>
<div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;<span class="comment"> *           code in this function after @c setup() has finished. When using</span></div>
<div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;<span class="comment"> *           FreeRTOS, @c loop() implements a low priority task on most</span></div>
<div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;<span class="comment"> *           microcontrollers, and crashes on some others, so we&#39;ll not use it.</span></div>
<div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;<span class="comment"> */</span></div>
<div class="line"><a name="l00266"></a><span class="lineno"><a class="line" href="main__drive_8cpp.html#afe461d27b9c48d5921c00d521181f12f">  266</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="main__drive_8cpp.html#afe461d27b9c48d5921c00d521181f12f">loop</a> () </div>
<div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;{</div>
<div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;}</div>
</div><!-- fragment --></div><!-- contents -->
<div class="ttc" id="aclass_share_html"><div class="ttname"><a href="class_share.html">Share</a></div><div class="ttdoc">Class for data to be shared in a thread-safe manner between tasks.</div><div class="ttdef"><b>Definition:</b> <a href="taskshare_8h_source.html#l00114">taskshare.h:115</a></div></div>
<div class="ttc" id="ataskshare_8h_html"><div class="ttname"><a href="taskshare_8h.html">taskshare.h</a></div><div class="ttdoc">Data which can be shared between tasks in a thread-safe manner.</div></div>
<div class="ttc" id="amain__drive_8cpp_html_a0d755a47b31dfe34438194d3286599cc"><div class="ttname"><a href="main__drive_8cpp.html#a0d755a47b31dfe34438194d3286599cc">duty_cycle</a></div><div class="ttdeci">Share&lt; uint32_t &gt; duty_cycle(&quot;Power&quot;)</div></div>
<div class="ttc" id="amain__drive_8cpp_html_a5d113b2e78f295f62b2c160ebb5d775e"><div class="ttname"><a href="main__drive_8cpp.html#a5d113b2e78f295f62b2c160ebb5d775e">task_enc</a></div><div class="ttdeci">void task_enc(void *p_params)</div><div class="ttdoc">Task which interacts with a user.</div><div class="ttdef"><b>Definition:</b> <a href="main__drive_8cpp_source.html#l00161">main_drive.cpp:161</a></div></div>
<div class="ttc" id="amain__drive_8cpp_html_aedae232608142fbbd4ece4cfe363e74c"><div class="ttname"><a href="main__drive_8cpp.html#aedae232608142fbbd4ece4cfe363e74c">task_sim</a></div><div class="ttdeci">void task_sim(void *p_params)</div><div class="ttdoc">Task which interacts with a user.</div><div class="ttdef"><b>Definition:</b> <a href="main__drive_8cpp_source.html#l00114">main_drive.cpp:114</a></div></div>
<div class="ttc" id="amain__drive_8cpp_html_afe461d27b9c48d5921c00d521181f12f"><div class="ttname"><a href="main__drive_8cpp.html#afe461d27b9c48d5921c00d521181f12f">loop</a></div><div class="ttdeci">void loop()</div><div class="ttdoc">Arduino's low-priority loop function, which we don't use.</div><div class="ttdef"><b>Definition:</b> <a href="main__drive_8cpp_source.html#l00266">main_drive.cpp:266</a></div></div>
<div class="ttc" id="amain__drive_8cpp_html_a83e2559905ce06de071389dfb6ea3b97"><div class="ttname"><a href="main__drive_8cpp.html#a83e2559905ce06de071389dfb6ea3b97">parseIntWithEcho</a></div><div class="ttdeci">int32_t parseIntWithEcho(Stream &amp;stream)</div><div class="ttdoc">Read an integer from a serial device, echoing input and blocking.</div><div class="ttdef"><b>Definition:</b> <a href="main__drive_8cpp_source.html#l00045">main_drive.cpp:45</a></div></div>
<div class="ttc" id="amain__drive_8cpp_html_a4fc01d736fe50cf5b977f755b675f11d"><div class="ttname"><a href="main__drive_8cpp.html#a4fc01d736fe50cf5b977f755b675f11d">setup</a></div><div class="ttdeci">void setup()</div><div class="ttdoc">Arduino setup function which runs once at program startup.</div><div class="ttdef"><b>Definition:</b> <a href="main__drive_8cpp_source.html#l00216">main_drive.cpp:216</a></div></div>
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="http://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.8.20
</small></address>
</body>
</html>
